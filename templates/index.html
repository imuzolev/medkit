<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ app_title }}</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- Animated gradient orbs -->
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    
    <div class="container">
        <div class="card">
            <h1 class="app-title">{{ app_title }}</h1>
            
            <!-- Upload zone -->
            <div class="upload-zone">
                <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">
                <input type="file" id="galleryInput" accept="image/jpeg,image/jpg,image/png,image/webp" style="display: none;">
                <button class="btn-upload" id="uploadBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>
                <div class="upload-dropdown" id="uploadDropdown">
                    <button class="dropdown-item" id="cameraBtn">
                        <span class="dropdown-icon camera">üì∑</span>
                        –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ
                    </button>
                    <button class="dropdown-item" id="galleryBtn">
                        <span class="dropdown-icon gallery">üñº</span>
                        –í—ã–±—Ä–∞—Ç—å –∏–∑ –≥–∞–ª–µ—Ä–µ–∏
                    </button>
                </div>
            </div>
            
            <!-- Preview area -->
            <div id="previewArea" class="preview-area" style="display: none;">
                <div id="singlePreview" class="single-preview">
                    <div class="preview-wrapper">
                        <img id="originalImage" src="" alt="–û—Ä–∏–≥–∏–Ω–∞–ª">
                    </div>
                    <button class="btn-process" id="processBtn">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å</button>
                </div>
                
                <div id="resultsPreview" class="results-preview" style="display: none;">
                    <div class="preview-wrapper">
                        <img id="resultImage" src="" alt="–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ">
                    </div>
                    <div id="resultStatus" class="success-message"></div>
                    <div id="resultDetails"></div>
                </div>
            </div>
            
            <!-- Upload spinner -->
            <div id="uploadSpinner" class="spinner" style="display: none;">
                <div class="spinner-circle"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ...</p>
            </div>
            
            <!-- Processing spinner -->
            <div id="loadingSpinner" class="spinner" style="display: none;">
                <div class="spinner-circle"></div>
                <p>–û–±—Ä–∞–±–æ—Ç–∫–∞...</p>
            </div>
            
            <!-- Error message -->
            <div id="errorMessage" class="error-message" style="display: none;"></div>
        </div>
    </div>
    
    <script>
        const cameraInput = document.getElementById('cameraInput');
        const galleryInput = document.getElementById('galleryInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadDropdown = document.getElementById('uploadDropdown');
        const cameraBtn = document.getElementById('cameraBtn');
        const galleryBtn = document.getElementById('galleryBtn');
        const processBtn = document.getElementById('processBtn');
        const previewArea = document.getElementById('previewArea');
        const singlePreview = document.getElementById('singlePreview');
        const resultsPreview = document.getElementById('resultsPreview');
        const originalImage = document.getElementById('originalImage');
        const resultImage = document.getElementById('resultImage');
        const resultStatus = document.getElementById('resultStatus');
        const resultDetails = document.getElementById('resultDetails');
        const uploadSpinner = document.getElementById('uploadSpinner');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const errorMessage = document.getElementById('errorMessage');
        
        let currentFile = null;
        
        // –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ –º–µ–Ω—é
        uploadBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            uploadDropdown.classList.toggle('open');
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
        document.addEventListener('click', () => {
            uploadDropdown.classList.remove('open');
        });
        
        uploadDropdown.addEventListener('click', (e) => {
            e.stopPropagation();
        });
        
        function openFilePicker(inputEl) {
            uploadDropdown.classList.remove('open');
            inputEl.value = '';
            hideError();
            // –î–∞–µ–º –±—Ä–∞—É–∑–µ—Ä—É –∑–∞–≤–µ—Ä—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–ª–∏–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –æ–∫–Ω–∞.
            setTimeout(() => inputEl.click(), 0);
        }

        // –ö–Ω–æ–ø–∫–∞ ¬´–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ¬ª
        cameraBtn.addEventListener('click', () => {
            openFilePicker(cameraInput);
        });
        
        // –ö–Ω–æ–ø–∫–∞ ¬´–í—ã–±—Ä–∞—Ç—å –∏–∑ –≥–∞–ª–µ—Ä–µ–∏¬ª
        galleryBtn.addEventListener('click', () => {
            openFilePicker(galleryInput);
        });

        // –û–±—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) {
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                uploadSpinner.style.display = 'none';
                showError('–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ JPG, PNG –∏–ª–∏ WEBP.');
                return;
            }
            
            // –î–µ—Ä–∂–∏–º —Å–ø–∏–Ω–Ω–µ—Ä –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞.
            currentFile = file;
            uploadSpinner.style.display = 'flex';
            // –ü—Ä—è—á–µ–º —Å—Ç–∞—Ä–æ–µ –ø—Ä–µ–≤—å—é, —á—Ç–æ–±—ã —Å–ø–∏–Ω–Ω–µ—Ä –±—ã–ª –∑–∞–º–µ—Ç–µ–Ω.
            previewArea.style.display = 'none';
            hideError();
            const spinnerStartedAt = Date.now();
            
            const reader = new FileReader();
            reader.onload = (ev) => {
                const minSpinnerMs = 350;
                const elapsed = Date.now() - spinnerStartedAt;
                const delay = Math.max(0, minSpinnerMs - elapsed);

                setTimeout(() => {
                    originalImage.src = ev.target.result;
                    uploadSpinner.style.display = 'none';
                    previewArea.style.display = 'block';
                    singlePreview.style.display = 'flex';
                    resultsPreview.style.display = 'none';
                }, delay);
            };
            reader.onerror = () => {
                uploadSpinner.style.display = 'none';
                previewArea.style.display = 'block';
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            };
            reader.readAsDataURL(file);
        }
        
        cameraInput.addEventListener('change', handleFileSelect);
        galleryInput.addEventListener('change', handleFileSelect);
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        processBtn.addEventListener('click', async () => {
            if (!currentFile) return;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏
            loadingSpinner.style.display = 'flex';
            singlePreview.style.display = 'none';
            hideError();
            
            try {
                const formData = new FormData();
                formData.append('image', currentFile);
                
                const response = await fetch('/process', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏');
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏
                resultImage.src = originalImage.src;
                resultStatus.textContent = data.is_complete ? '–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è –ø–æ–ª–Ω–∞—è' : '–ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è –Ω–µ–ø–æ–ª–Ω–∞—è';
                resultStatus.classList.toggle('status-incomplete', !data.is_complete);
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤—ã–π —Å–ø–∏—Å–æ–∫
                if (data.is_complete) {
                    resultDetails.innerHTML = '<div class="result-complete">–í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã –Ω–∞ –º–µ—Å—Ç–µ</div>';
                } else if (data.missing && data.missing.length > 0) {
                    const items = data.missing.map(m => `<li>${m}</li>`).join('');
                    resultDetails.innerHTML = `<ul class="missing-list">${items}</ul>`;
                } else {
                    resultDetails.innerHTML = '';
                }
                
                loadingSpinner.style.display = 'none';
                resultsPreview.style.display = 'block';
                
            } catch (error) {
                loadingSpinner.style.display = 'none';
                singlePreview.style.display = 'flex';
                showError(error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
            }
        });
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–æ–∫
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
        
        function hideError() {
            errorMessage.style.display = 'none';
        }
    </script>
</body>
</html>
